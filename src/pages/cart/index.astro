---
import { actions } from 'astro:actions';
import MainLayout from '~/layouts/MainLayout.astro';
import { Formatter } from '~/utils/formatter';

export const prerender = false;

const cart = Astro.cookies.get('cart');

const { data: products, error } = await Astro.callAction(actions.loadProductsFromCart, cart);

const total = products?.reduce((acc, product) => acc + product.price * product.quantity, 0);
---

<MainLayout title='Carrito de compras'>
	<h1 class='my-4'>Carrito</h1>
	<section class='grid grid-cols-1 md:grid-cols-2'>
		<!-- Productos -->
		<div>
			{
				error ? <p class='text-red-500'>Error al cargar los productos del carrito.</p>
				: products.length === 0 ? <p>Tu carrito está vacío.</p>
				: <ul class='space-y-4'>
						{products.map((product) => (
							<li
								data-key={product.productId}
								class='border p-4 rounded flex gap-2 shadow-lg border-none'>
								<div>
									<img
										src={product.image}
										alt={product.title}
										class='w-24 h-24 object-cover'
									/>
								</div>
								<div class='flex flex-col'>
									<h2 class='text-lg font-semibold'>{product.title}</h2>
									<p>Talla: {product.size}</p>
									<p>Cantidad: {product.quantity}</p>
									<p>Precio: ${product.price.toFixed(2)}</p>
									<button
										data-id={product.productId}
										data-size={product.size}
										class='bg-blue-400 rounded p-2 text-white drop-shadow-sm hover:bg-blue-500 w-20 my-2'>
										Eliminar
									</button>
								</div>
							</li>
						))}
					</ul>
			}
		</div>

		<!-- Totales -->

		<div class='bg-black h-[330px] text-white p-6 rounded-lg drop-shadow-lg order-1 mx-8'>
			<h2 class='text-lg font-semibold mb-4'>Resumen de compra</h2>

			<div class='flex justify-between text-gray-400 mb-2'>
				<span>Envío</span>
				<span>Gratis</span>
			</div>

			<div class='flex justify-between text-gray-400 mb-4'>
				<span>SubTotal </span>
				<span>{Formatter.currency(total!)}</span>
			</div>
			<div class='flex justify-between text-gray-400 mb-4'>
				<span>Impuesto </span>
				<span>{Formatter.currency(total! * 0.15)}</span>
			</div>

			<div class='flex justify-between text-xl font-bold'>
				<span>Total</span>
				<span>{Formatter.currency(total! * 1.15)}</span>
			</div>

			<button class='mt-10 w-full bg-blue-700 text-gray-300 py-3 rounded-lg hover:bg-gray-600 transition-all'>
				PAGAR
			</button>
		</div>
	</section>
</MainLayout>

<script>
	import { navigate } from 'astro:transitions/client';
	import { itemsInCart } from '~/store/cart.store';
	import { CartCookiesClient } from '~/utils/cart-cookies';

	document.addEventListener('astro:page-load', () => {
		const buttons = document.querySelectorAll('button[data-id]');

		buttons.forEach((button) => {
			button.addEventListener('click', async () => {
				const productId = button.getAttribute('data-id') ?? '';
				const size = button.getAttribute('data-size') ?? '';

				const cart = CartCookiesClient.removeItem(productId, size);
				itemsInCart.set(cart.length);
				// window.location.reload();
				await navigate('/cart');
			});
		});
	});
</script>
